import React, { useState, useEffect } from 'react';
import {
  StyleSheet,
  SafeAreaView,
  Text,
  ImageBackground,
  View,
  Image,
  TouchableOpacity,
  Linking,
  ScrollView,
  FlatList,
} from 'react-native';
import { fetchUserAttributes } from 'aws-amplify/auth';
import { useNavigation } from '@react-navigation/native'
import { Auth } from "aws-amplify";

export default function HomeScreen() {
  const navigation = useNavigation();

  const [temperature, setTemperature] = useState(null);
  const [weatherDescription, setWeatherDescription] = useState("");
  const [moonPhase, setMoonPhase] = useState("");
  const [news, setNews] = useState([]);
  const [stateString, setStateString] = useState("");
  const [city, setCity] = useState("");
  const [cloudCoverage, setCloudCoverage] = useState(null);
  const [windSpeed, setWindSpeed] = useState(null);
  const [moonrise, setMoonrise] = useState(null);
  const [sunset, setSunset] = useState(null);
  const [currentDay, setCurrentDay] = useState("");
  const [isSettingsBoxVisible, setIsSettingsBoxVisible] = useState(false);

  useEffect(() => {
    fetchWeather();
    fetchNews();
    handleFetchUserAttributes();
    setCurrentDay(getCurrentDay());
  }, []);

  const getCurrentDay = () => {
    const daysOfWeek = [
      "Sunday",
      "Monday",
      "Tuesday",
      "Wednesday",
      "Thursday",
      "Friday",
      "Saturday",
    ];
    const today = new Date();
    return daysOfWeek[today.getDay()];
  };

  const capitalizeDescription = (desc) => {
    return desc
      .split(" ")
      .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
      .join(" ");
  };

  function getPhaseName(moonPhaseValue) {
    if (moonPhaseValue === 0 || moonPhaseValue === 1) return 'New Moon';
    if (moonPhaseValue === 0.25) return 'First Quarter';
    if (moonPhaseValue === 0.5) return 'Full Moon';
    if (moonPhaseValue === 0.75) return 'Last Quarter';
    if (moonPhaseValue > 0 && moonPhaseValue < 0.25) return 'Waxing Crescent';
    if (moonPhaseValue > 0.25 && moonPhaseValue < 0.5) return 'Waxing Gibbous';
    if (moonPhaseValue > 0.5 && moonPhaseValue < 0.75) return 'Waning Gibbous';
    if (moonPhaseValue > 0.75 && moonPhaseValue < 1) return 'Waning Crescent';
  }

  async function handleFetchUserAttributes() {
    try {
      const userAttributes = await fetchUserAttributes();
      setStateString(userAttributes['custom:state']);
      console.log(stateString);
    } catch (error) {
      console.log(error);
    }
  }

  useEffect(() => {
    handleFetchUserAttributes();
  }, []);

  async function fetchEvents() {
    const eventsUrl =
      'https://fi4o4iz0e2.execute-api.us-east-2.amazonaws.com/dev/recommendationsData?cityName=Dallas&stateName=TX';
    try {
      const response = await fetch(eventsUrl);
      if (!response.ok) throw new Error(`Response status: ${response.status}`);
      const eventData = await response.json();
      if (Array.isArray(eventData.body)) {
        const formattedEvents = eventData.body.map((event) => {
          const eventDate = new Date(event.date);
          const formattedDate = eventDate.toLocaleDateString('en-US', {
            day: 'numeric',
            month: 'short',
          });
          return { ...event, date: formattedDate };
        });
        setEvents(formattedEvents);
      } else {
        console.error('Invalid event data format:', eventData);
      }
    } catch (error) {
      console.error('Fetch events error:', error);
    }
  }

  const fetchWeather = async () => {
    const url =
      "https://fi4o4iz0e2.execute-api.us-east-2.amazonaws.com/dev/weatherData?cityName=Dallas";

    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Response status: ${response.status}`);

      const weatherData = await response.json();
      setTemperature(Math.round(weatherData.body.temp));
      setWeatherDescription(weatherData.body.description);
      setMoonPhase(getPhaseName(weatherData.body.moonphase));
      setCloudCoverage(weatherData.body.clouds);
      setWindSpeed(weatherData.body.wind);
      setMoonrise(weatherData.body.moonrise);
      setSunset(weatherData.body.sunset);
    } catch (error) {
      console.error(error.message);
    }
  };

  const handleSignOut = async () => {
    try {
      // await Auth.signOut();
      // Alert.alert("Signed Out", "You have been signed out.");
      navigation.navigate("authenticationScreens");
    } catch (error) {
      console.error("Error signing out: ", error);
      Alert.alert("Sign Out Error", "Failed to sign out. Please try again.");
    }
  };

  const fetchNews = async () => {
    const newsUrl =
      "https://fi4o4iz0e2.execute-api.us-east-2.amazonaws.com/dev/newsData";

    try {
      const response = await fetch(newsUrl);
      if (!response.ok) throw new Error(`Response status: ${response.status}`);

      const newsData = await response.json();
      const parsedData = JSON.parse(newsData.body);
      const astronomyKeywords = [
        "astronomy",
        "space",
        "NASA",
        "planet",
        "star",
        "galaxy",
        "cosmos",
        "universe",
      ];

      const filteredNews = parsedData.filter((article) =>
        astronomyKeywords.some(
          (keyword) =>
            (article.title && article.title.toLowerCase().includes(keyword)) ||
            (article.description &&
              article.description.toLowerCase().includes(keyword))
        )
      );

      setNews(filteredNews.slice(0, 3));
    } catch (error) {
      console.error("Fetch news error:", error.message);
    }
  };

  const toggleSettingsBox = () => {
    setIsSettingsBoxVisible((prevState) => !prevState);
  };
  
  const moonPhaseImages = {
    "New Moon": '../assets/newAssets/universalAssets/moonIcons/full-moon.png',
    "First Quarter": "../assets/newAssets/universalAssets/moonIcons/first-quarter.png",
    "Full Moon": "../assets/newAssets/universalAssets/moonIcons/full-moon.png",
    "Last Quarter": "../assets/newAssets/universalAssets/moonIcons/third-quarter.png",
    "Waxing Crescent": "../assets/newAssets/universalAssets/moonIcons/waxing-crescent.png",
    "Waxing Gibbous": "../assets/newAssets/universalAssets/moonIcons/waxing-gibbous.png",
    "Waning Gibbous": "/Users/thebenzsecrets/lumina4.0/assets/newAssets/universalAssets/moonIcons/waning-gib.png",
    "Waning Crescent": "../assets/newAssets/universalAssets/moonIcons/waning-crescent.png",
  };
  
  const weatherIcons = {
    "clear sky": require("../assets/newAssets/universalAssets/weatherIcons/sun.png"),
    "few clouds": require("../assets/newAssets/universalAssets/weatherIcons/cloud.png"),
    "scattered clouds": require("../assets/newAssets/universalAssets/weatherIcons/broken-cloud.png"),
    "broken clouds": require("../assets/newAssets/universalAssets/weatherIcons/broken-cloud.png"),
    "shower rain": require("../assets/newAssets/universalAssets/weatherIcons/rain.png"),
    "rain": require("../assets/newAssets/universalAssets/weatherIcons/rain.png"),
    "thunderstorm": require("../assets/newAssets/universalAssets/weatherIcons/storm.png"),
    "snow": require("../assets/newAssets/universalAssets/weatherIcons/snowy.png"),
    "mist": require("../assets/newAssets/universalAssets/weatherIcons/mist.png"),
    default: require("../assets/newAssets/universalAssets/weatherIcons/cloud (1).png"),
  };

  return (
    <View style={styles.container}>
      {/* Background Image */}
      <ImageBackground
        source={require("../assets/newAssets/universalAssets/NewBackground.png")}
        style={styles.background}
      >
        {/* Header Section */}
        <View style={styles.header}>
          <Image
            source={require("../assets/newAssets/universalAssets/LuminaLogoNew.png")}
            style={styles.logo}
          />
          <TouchableOpacity onPress={toggleSettingsBox}>
            <Image
              source={require("../assets/newAssets/calendarAssets/calendarIcons/configuration-gear 1.png")}
              style={styles.settingsIcon}
            />
          </TouchableOpacity>
        </View>
        {/* Settings Container */}
        {isSettingsBoxVisible && (
          <View style={styles.settingsBox}>
            <Text style={styles.settingsBoxText}>Settings</Text>
            <TouchableOpacity
              style={styles.signOutButton}
              onPress={handleSignOut}
            >
              <Text style={styles.signOutButtonText}>Sign Out</Text>
            </TouchableOpacity>
          </View>
        )}

        {/* Main Content */}
        <SafeAreaView>
          <ScrollView contentContainerStyle={styles.scrollContent}>
            {/* Weather Section */}
            <View style={styles.topInfoContainer}>
              <View style={styles.weatherCard}>
                <View style={styles.weatherLeft}>
                  <Text style={styles.weatherDescText}>
                    {weatherDescription
                      ? capitalizeDescription(weatherDescription)
                      : "..."}
                  </Text>
                  <Image
                    source={
                      weatherIcons[weatherDescription.toLowerCase()] ||
                      weatherIcons["default"]
                    }
                    style={styles.weatherIcon}
                  />
                </View>
                <View style={styles.verticalLine} />
                <View style={styles.weatherRight}>
                  <Text style={styles.cityText}>
                    Richardson, {stateString || "..."}
                  </Text>
                  <Text style={styles.dayText}>{currentDay}</Text>
                  <Text style={styles.weatherText}>
                    {temperature ? `${temperature}Â°F` : "..."}
                  </Text>
                </View>
              </View>

              {/* Moon Phase Section */}
              <View style={styles.moonRowContainer}>
                <View style={styles.moonLeftBox}>
                  <Text style={styles.moonPhaseText}>
                    {moonPhase || "..."}
                  </Text>
                  <Image
                    source={{ uri: moonPhaseImages[moonPhase] }}
                    style={styles.moonImage}
                  />
                </View>
                <View style={styles.moonRightBox}>
                  <View style={styles.detailRow}>
                    <Image
                      source={require("../assets/newAssets/universalAssets/weatherIcons/cloud.png")}
                      style={styles.iconStyle}
                    />
                    <Text style={styles.weatherDetailText}>
                      {cloudCoverage !== null
                        ? `Cloud Coverage: ${cloudCoverage}%`
                        : "..."}
                    </Text>
                  </View>
                  <View style={styles.detailRow}>
                    <Image
                      source={require("/Users/thebenzsecrets/lumina4.0/assets/newAssets/universalAssets/weatherIcons/night (1).png")}
                      style={styles.iconStyle}
                    />
                    <Text style={styles.weatherDetailText}>
                      {moonrise ? `Moonrise: ${moonrise}` : "..."}
                    </Text>
                  </View>
                  <View style={styles.detailRow}>
                    <Image
                      source={require("../assets/newAssets/universalAssets/weatherIcons/sun.png")}
                      style={styles.iconStyle}
                    />
                    <Text style={styles.weatherDetailText}>
                      {sunset ? `Sunset: ${sunset}` : "..."}
                    </Text>
                  </View>
                  <View style={styles.detailRow}>
                    <Image
                      source={require("../assets/newAssets/universalAssets/weatherIcons/wind.png")}
                      style={styles.iconStyle}
                    />
                    <Text style={styles.weatherDetailText}>
                      {windSpeed !== null ? `Wind: ${windSpeed} mph` : "..."}
                    </Text>
                  </View>
                </View>
              </View>

              {/* Planning Button */}
                <View style={[styles.planningButtonContainer, {marginTop: 40}]}>
                  <TouchableOpacity
                    style={styles.planningButton}
                    onPress={() => navigation.navigate("calendarScreen")}
                  >
                    <Image
                      source={require("/Users/thebenzsecrets/lumina4.0/assets/newAssets/universalAssets/button-image.png")}
                      style={styles.planningImage}
                    />
                  </TouchableOpacity>
                </View>

              {/* News Section */}
              <View style={styles.newsContainer}>
                <Text style={styles.sectionTitle}>News</Text>
                  <ScrollView horizontal showsHorizontalScrollIndicator={false}>
                    {news.map((item, index) => (
                      <TouchableOpacity
                        key={index}
                        style={styles.newsItem}
                        onPress={() => Linking.openURL(item.url)}
                      >
                        <Image
                          source={{ uri: item.urlToImage }}
                          style={styles.newsImage}
                        />
                        <View style={styles.newsTextContainer}>
                          <Text style={styles.newsTitle} numberOfLines={1}>
                            {item.title}
                          </Text>
                          <Text style={styles.newsDesc} numberOfLines={3}>
                            {item.description}
                          </Text>
                        </View>
                      </TouchableOpacity>
                    ))}
                  </ScrollView>
              </View>
            </View>
          </ScrollView>
        </SafeAreaView>
      </ImageBackground>
    </View>
  );
}

const styles = StyleSheet.create({
  Â Â container: {
  Â Â Â Â flex: 1,
  Â Â Â Â backgroundColor: "transparent",
  Â Â },
  Â Â background: {
  Â Â Â Â flex: 1,
  Â Â Â Â resizeMode: "cover",
  Â Â Â Â justifyContent: "center",
  Â Â Â Â alignItems: "center",
  Â Â Â Â backgroundColor: "rgba(0, 0, 0, 0.4)", 
  Â Â },
  
  Â Â // Header styles
  Â Â header: {
  Â Â Â Â position: "absolute",
  Â Â Â Â top: 40,
  Â Â Â Â left: 20,
  Â Â Â Â right: 20,
  Â Â Â Â flexDirection: "row",
  Â Â Â Â justifyContent: "space-between",
  Â Â Â Â alignItems: "center",
  Â Â Â Â zIndex: 5,
  Â Â },
  Â Â logo: {
  Â Â Â Â width: 140,
  Â Â Â Â height: 60,
  Â Â Â Â opacity: 0.3,
  Â Â Â Â resizeMode: "contain",
  Â Â },
  Â Â settingsIcon: {
  Â Â Â Â width: 25,
  Â Â Â Â height: 25,
  Â Â Â Â resizeMode: "contain",
  Â Â Â Â zIndex: 10,
  Â Â },
  Â Â settingsBox: {
  Â Â Â Â position: "absolute",
  Â Â Â Â top: 100,
  Â Â Â Â right: 20,
  Â Â Â Â backgroundColor: "#000",
  Â Â Â Â padding: 20,
  Â Â Â Â borderRadius: 10,
  Â Â Â Â width: 200,
  Â Â Â Â shadowColor: "#000",
  Â Â Â Â shadowOffset: { width: 0, height: 2 },
  Â Â Â Â shadowOpacity: 0.2,
  Â Â Â Â shadowRadius: 4,
  Â Â Â Â zIndex: 10,
  Â Â },
  Â Â settingsBoxText: {
  Â Â Â Â fontSize: 18,
  Â Â Â Â color: "#fff",
  Â Â Â Â marginBottom: 10,
  Â Â Â Â fontWeight: "800",
  Â Â },
  Â Â signOutButton: {
  Â Â Â Â marginTop: 10,
  Â Â Â Â backgroundColor: "#BA91F9",
  Â Â Â Â padding: 20,
  Â Â Â Â borderRadius: 5,
  Â Â Â Â alignItems: "center",
  Â Â Â Â paddingHorizontal: 40,
  Â Â },
  Â Â signOutButtonText: {
  Â Â Â Â color: "#000",
  Â Â Â Â fontWeight: "bold",
  Â Â },
  Â Â contentText: {
  Â Â Â Â marginTop: 200,
  Â Â Â Â fontSize: 16,
  Â Â Â Â color: "#333",
  Â Â Â Â padding: 10,
  Â Â Â Â },
  
  Â Â // Top information container styles
  Â Â topInfoContainer: {
  Â Â Â Â width: "90%",
  Â Â Â Â marginTop: 90,
  Â Â Â Â justifyContent: "center",
  Â Â Â Â alignItems: "center", 
  Â Â },
  Â Â weatherCard: {
  Â Â Â Â flexDirection: "row", 
  Â Â Â Â alignItems: "center",
  Â Â Â Â justifyContent: "space-between", 
  Â Â Â Â padding: 15,
  Â Â Â Â backgroundColor: "rgba(0,0,0,0.4)",
  Â Â Â Â borderRadius: 12,
  Â Â Â Â marginTop: -30,
  Â Â Â Â width: "105%", 
  Â Â Â Â marginLeft: 40,
  Â Â Â Â height: 135,
  Â Â },
  Â Â weatherLeft: {
  Â Â Â Â alignItems: "center", 
  Â Â Â Â justifyContent: "center",
  Â Â Â Â marginLeft: 30,
  Â Â },
  Â Â weatherDescText: {
  Â Â Â Â fontSize: 14,
  Â Â Â Â color: "#fff",
  Â Â Â Â marginBottom: 5, 
  Â Â },
  Â Â weatherIcon: {
  Â Â Â Â width: 70, 
  Â Â Â Â height: 70,
  Â Â Â Â resizeMode: "contain",
  Â Â Â Â marginTop: 5,
  Â Â },
  Â Â weatherRight: {
  Â Â Â Â flex: 1,
  Â Â Â Â alignItems: "left", 
  Â Â Â Â justifyContent: "left",
  Â Â Â Â marginLeft: 50,
  Â Â },
  Â Â weatherText: {
  Â Â Â Â fontSize: 40,
  Â Â Â Â color: "#fff",
  Â Â Â Â fontWeight: "bold",
  Â Â Â Â marginTop: 10,
  Â Â },
  Â Â cityText: {
  Â Â Â Â fontSize: 20,
  Â Â Â Â color: "#fff",
  Â Â Â Â marginTop: 5,
  Â Â Â Â marginBottom: 20,
  Â Â },Â Â 
  Â Â moonImage: {
  Â Â Â Â width: 70,
  Â Â Â Â height: 80,
  Â Â Â Â resizeMode: "contain",
  Â Â Â Â alignItems: "center",
  Â Â Â Â justifyContent: "center",
  Â Â Â Â marginTop: 5,
  Â Â },
  Â Â moonPhaseText: {
  Â Â Â Â fontSize: 14,
  Â Â Â Â color: "#fff",
  Â Â Â Â marginTop: 5,
  Â Â Â Â marginBottom: 5,
  Â Â },
  Â Â weatherDetailText: {
  Â Â Â Â fontSize: 13,
  Â Â Â Â color: "#B5B5B5",
  Â Â Â Â marginTop: 5,
  Â Â Â Â marginBottom: 5,
  Â Â Â Â marginLeft: 40,
  Â Â Â Â fontFamily: "Nunito",
  Â Â },
  Â Â moonRowContainer: {
  Â Â Â Â flexDirection: "row",
  Â Â Â Â width: "90%",
  Â Â Â Â justifyContent: "space-between",
  Â Â Â Â alignItems: "center",
  Â Â Â Â marginTop: 30, 
  Â Â Â Â marginRight: 10,
  Â Â },
  Â Â moonLeftBox: {
  Â Â Â Â backgroundColor: "rgba(0,0,0,0.4)", 
  Â Â Â Â borderRadius: 12,
  Â Â Â Â alignItems: "center",
  Â Â Â Â padding: 10,
  Â Â Â Â marginRight: 20, 
  Â Â Â Â height: 130, 
  Â Â Â Â width: "45%",
  Â Â },
  Â Â moonRightBox: {
  Â Â Â Â backgroundColor: "rgba(0,0,0,0.4)", 
  Â Â Â Â borderRadius: 12,
  Â Â Â Â padding: 10, 
  Â Â Â Â alignItems: "flex-start", 
  Â Â Â Â height: 130, 
  Â Â Â Â width: "65%",
  Â Â },
  Â Â detailRow: {
  Â Â Â Â flexDirection: "row",
  Â Â Â Â alignItems: "center",
  Â Â Â Â marginVertical: 0, 
  Â Â },
  Â Â iconStyle: {
  Â Â Â Â width: 19,
  Â Â Â Â height: 19,
  Â Â Â Â marginRight: -25, 
  Â Â Â Â marginLeft: 20,
  Â Â Â Â resizeMode: "contain", 
  Â Â },
  Â Â dayText: {
  Â Â Â Â fontSize: 14,
  Â Â Â Â color: "#fff",
  Â Â Â Â marginTop: -16,
  Â Â Â Â fontWeight: "300",
  Â Â },
  Â Â verticalLine: {
  Â Â Â Â width: 1,Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
  Â Â Â Â height: "100%",Â Â Â Â Â Â Â Â 
  Â Â Â Â backgroundColor: "rgba(255, 255, 255, 0.2)", 
  Â Â Â Â marginHorizontal: 10,Â Â Â Â 
  Â Â Â Â marginLeft: 40,
  Â Â },Â Â 
  
  Â Â // Planning button styles
  Â Â planningButtonContainer: {
  Â Â Â Â alignItems: "center",
  Â Â Â Â marginVertical: 20,
  Â Â Â Â marginLeft: 40,
  Â Â },
  Â Â planningButton: {
  Â Â Â Â backgroundColor: "#BA91F9",
  Â Â Â Â paddingVertical: 25,
  Â Â Â Â paddingHorizontal: 25,
  Â Â Â Â borderRadius: 15,
  Â Â Â Â alignItems: "center",
  Â Â Â Â opacity: 0.8,
  Â Â },
  Â Â buttonContent: {
  Â Â Â Â flexDirection: "row",
  Â Â Â Â alignItems: "center",
  Â Â },
  Â Â planningImage: {
  Â Â Â Â width: 310,
  Â Â Â Â height: 100,
  Â Â Â Â resizeMode: "contain",
  Â Â Â Â alignSelf: "center",
  Â Â },
  Â Â // News section styles
  Â Â sectionTitle: {
  Â Â Â Â fontSize: 23,
  Â Â Â Â color: "#fff",
  Â Â Â Â fontWeight: "semi-bold",
  Â Â Â Â marginBottom: 10,
  Â Â Â Â fontFamily: "Nunito-Bold",
  Â Â },
  Â Â newsContainer: {
  Â Â Â Â width: "140%",
  Â Â Â Â marginTop: 10,
  Â Â Â Â marginLeft: 170,
  Â Â },
  Â Â newsItem: {
  Â Â Â Â flexDirection: "row",
  Â Â Â Â width: 360, 
  Â Â Â Â backgroundColor: "rgba(10, 10, 10, 0.5)",
  Â Â Â Â padding: 25,
  Â Â Â Â borderRadius: 10,
  Â Â Â Â marginRight: 10,
  Â Â },
  Â Â newsImage: {
  Â Â Â Â width: 80, 
  Â Â Â Â height: 80,
  Â Â Â Â borderRadius: 5,
  Â Â Â Â marginRight: 10, 
  Â Â },
  Â Â newsTextContainer: {
  Â Â Â Â flex: 1, 
  Â Â Â Â justifyContent: "center",
  Â Â },
  Â Â newsTitle: {
  Â Â Â Â color: "#fff",
  Â Â Â Â fontSize: 15,
  Â Â Â Â fontWeight: "700",
  Â Â },
  Â Â newsDesc: {
  Â Â Â Â color: "#aaa",
  Â Â Â Â fontSize: 14,
  Â Â Â Â marginTop: 7,
  Â Â },
  Â Â settingsBox: {
  Â Â Â Â position: "absolute",
  Â Â Â Â top: 80,
  Â Â Â Â right: 40,
  Â Â Â Â backgroundColor: "rgba(0,0,0,0.9)",
  Â Â Â Â padding: 40,
  Â Â Â Â borderRadius: 10,
  Â Â Â Â shadowColor: "#fff",
  Â Â Â Â shadowOffset: { width: 0, height: 7 },
  Â Â Â Â shadowOpacity: 0.2,
  Â Â Â Â shadowRadius: 9,
  Â Â Â Â zIndex: 20,
  Â Â },
  Â Â settingsBoxText: {
  Â Â Â Â fontSize: 19,
  Â Â Â Â color: "#fff",
  Â Â Â Â marginBottom: 10,
  Â Â },
  });